(function(){angular.module("iAspireApp").factory("ReportsConstants",function(){var a=this;a.SurveyID=-1;a.SurveyTitle="";a.ActiveSurvey=null;a.OriginalVotes=null;a.OriginalSurvey=null;a.OriginalFilters=null;a.AllVotes=[];a.StartDate=null;a.EndDate=null;a.FilteredVotesCount=-1;a.CurrentDateTimeAnswerID=-1;a.DistrictIDAnswerID=-1;a.SchoolIDAnswerID=-1;a.TeacherIDAnswerID=-1;a.SubjectIDAnswerID=-1;a.GradeIDAnswerID=-1;a.ObserverIDAnswerID=-1;a.ObservverNameAnswerID=-1;a.ActiveVoters=[];a.SetSurveyID=
function(c){a.SurveyID=c};a.SetSurveyTitle=function(c){a.SurveyTitle=c.split(":").join("")};a.SetFilteredVotesCount=function(c){a.FilteredVotesCount=c};a.SetActiveSurvey=function(c){a.ActiveSurvey=c};a.SetOriginalVotes=function(c){a.OriginalVotes=angular.copy(c)};a.SetOriginalSurvey=function(c){a.OriginalSurvey=angular.copy(c)};a.SetOriginalFilters=function(c){a.OriginalFilters=angular.copy(c)};a.SetAllVotes=function(c){a.AllVotes=c};a.SetCurrentDateTimeAnswerID=function(c){a.CurrentDateTimeAnswerID=
c};a.SetDistrictIDAnswerID=function(c){a.DistrictIDAnswerID=c};a.SetSchoolIDAnswerID=function(c){a.SchoolIDAnswerID=c};a.SetTeacherIDAnswerID=function(c){a.TeacherIDAnswerID=c};a.SetSubjectIDAnswerID=function(c){a.SubjectIDAnswerID=c};a.SetGradeIDAnswerID=function(c){a.GradeIDAnswerID=c};a.SetObserverIDAnswerID=function(c){a.ObserverIDAnswerID=c};a.SetObserverNameAnswerID=function(c){a.ObserverNameAnswerID=c};a.SetStartDate=function(c){a.StartDate=c};a.SetEndDate=function(c){a.EndDate=c};a.SetActiveVoters=
function(c){a.ActiveVoters=c};return a}).factory("ReportsControllerLogic",["ReportsConstants",function(a){var c={},e={},u={};this.GetVoterAnswerValuesByAnswerID=function(d){if(u[a.SurveyID]&&u[a.SurveyID][d])return u[a.SurveyID][d];var c=[],e;for(e in a.AllVotes){var t=angular.copy({AnswerID:d,VoterID:a.AllVotes[e].VoterID,StartDate:a.AllVotes[e].StartDate,DateFromForm:null,VoterAnswerValue:null}),g=null,m=null;-1===a.CurrentDateTimeAnswerID&&(m=-1);var l=Object.keys(a.AllVotes[e]),n;for(n in l)if(g||
-1<l[n].indexOf("_"+d)&&(g=a.AllVotes[e][l[n]]),m||-1<l[n].indexOf("_"+a.CurrentDateTimeAnswerID)&&(m=a.AllVotes[e][l[n]]),g&&m)break;g&&""!==g&&(t.VoterAnswerValue=g,t.DateFromForm=m,c.push(t))}void 0===u[a.SurveyID]&&(u[a.SurveyID]={});return u[a.SurveyID][d]=c};this.GetVoterCountByDateRange=function(d,e){if(c[a.SurveyID]&&c[a.SurveyID][d]&&c[a.SurveyID][d][e])return c[a.SurveyID][d][e];var u=0,t=moment(angular.copy(a.StartDate).year(),"YYYY"),g=moment(angular.copy(a.StartDate).year(),"YYYY");switch(d){case "dayOfYear":t[d](e).startOf("day").subtract(1,
"millisecond");g[d](e).endOf("day").add(1,"millisecond");break;default:t[d](e),t.startOf(d),t.subtract(1,"millisecond"),g[d](e),g.endOf(d),g.add(1,"millisecond")}for(var m in a.AllVotes){var l=null;if(-1<a.CurrentDateTimeAnswerID){var n=Object.keys(a.AllVotes[m]),p;for(p in n)if(-1<n[p].indexOf("_"+a.CurrentDateTimeAnswerID)){l=moment(a.AllVotes[m][n[p]],"MM-DD-YYYY");break}}else l=moment(a.AllVotes[m].StartDate,"YYYY-MM-DDTHH:mm:ss");l.isBetween(t,g)&&u++}void 0===c[a.SurveyID]&&(c[a.SurveyID]={});
void 0===c[a.SurveyID][d]&&(c[a.SurveyID][d]={});return c[a.SurveyID][d][e]=u};this.GetVoterCountByDateRangeIfQuestionWasAnswered=function(d,c,u){if(e[a.SurveyID]&&e[a.SurveyID][d]&&e[a.SurveyID][d][c])return e[a.SurveyID][d][c];var t=0,g=moment(angular.copy(a.StartDate).year(),"YYYY"),m=moment(angular.copy(a.StartDate).year(),"YYYY");switch(d){case "dayOfYear":g[d](c).startOf("day").subtract(1,"millisecond");m[d](c).endOf("day").add(1,"millisecond");break;default:g[d](c),g.startOf(d),g.subtract(1,
"millisecond"),m[d](c),m.endOf(d),m.add(1,"millisecond")}for(var l in a.AllVotes){var n=!1,p=Object.keys(a.AllVotes[l]),x;for(x in p)if(0===p[x].indexOf(u+"_")&&""!==a.AllVotes[l][p[x]]){n=!0;break}if(!0===n){n=null;if(-1<a.CurrentDateTimeAnswerID){var p=Object.keys(a.AllVotes[l]),w;for(w in p)if(-1<p[w].indexOf("_"+a.CurrentDateTimeAnswerID)){n=moment(a.AllVotes[l][p[w]],"MM-DD-YYYY");break}}else n=moment(a.AllVotes[l].StartDate,"YYYY-MM-DDTHH:mm:ss");n.isBetween(g,m)&&t++}}void 0===e[a.SurveyID]&&
(e[a.SurveyID]={});void 0===e[a.SurveyID][d]&&(e[a.SurveyID][d]={});return e[a.SurveyID][d][c]=t};this.ClearCache=function(){c={};e={};u={}};return this}]).controller("ReportsController",["DataService","$scope","$interval","ProjectConstants","ReportsConstants","SMAAlertFactory","ActiveFilterLogic","ReportingQuestionInterface","ReportsControllerLogic",function(a,c,e,u,d,C,F,t,g){function m(){b.SurveyList.push({SurveyID:-1,Title:"Select Form"});var d=!1,c=!1;a.getTESurveyListForUser().success(function(a,
I,h,e){function A(a,b){return b.filter(function(b){return b.SurveyID===a}).length}for(var q in a)0===A(a[q].SurveyID,b.SurveyList)&&b.SurveyList.push(a[q]);d=!0;l(d,c)}).error(function(a,b,h,e){d=!0;l(d,c)});a.getSESurveyListForUser().success(function(a,e,h,g){function A(a,b){return b.filter(function(b){return b.SurveyID===a}).length}for(var q in a)0===A(a[q].SurveyID,b.SurveyList)&&b.SurveyList.push(a[q]);c=!0;l(d,c)}).error(function(a,b,h,e){c=!0;l(d,c)})}function l(a,d){!0===a&&!0===d&&(b.SurveysListIsLoading=
!1)}function n(c,z,f){var e=!1,h=!1,g=!1;a.getSurveyVariables(c).success(function(a,c,z,D){for(var f in a)b.FilterOptions.push(a[f]);d.SetOriginalFilters(angular.copy(b.FilterOptions));e=!0;p(e,h,g)}).error(function(a,b,c,d){e=!0;p(e,h,g)});a.getVotesForSurveyBetweenRange(c,z,f).success(function(a,c,z,D){if(a.length&&0<a.length){c=[];for(var f in a){for(var l in a[f].PivotAnswers)a[f][a[f].PivotAnswers[l].Name]=a[f].PivotAnswers[l].Value;a[f].PivotAnswers=null;c.push(a[f])}a=c}else a=[];for(var m in a)b.AllVotes.push(a[m]);
d.SetOriginalVotes(angular.copy(b.AllVotes));h=!0;p(e,h,g)}).error(function(a,b,c,d){h=!0;p(e,h,g)});a.getFullSurveyDetails(c).success(function(a,c,z,D){b.ActiveSurvey=a;g=!0;d.SetOriginalSurvey(angular.copy(b.ActiveSurvey));p(e,h,g)}).error(function(a,b,c,d){g=!0;p(e,h,g)})}function p(a,c,f){function e(a,b){return 0===a.filter(function(a){return a.Value===b?!0:!1}).length}if(!0===a&&!0===c&&!0===f){x();d.SetActiveSurvey(b.ActiveSurvey);d.SetAllVotes(b.AllVotes);c=g.GetVoterAnswerValuesByAnswerID(d.ObserverIDAnswerID);
f=g.GetVoterAnswerValuesByAnswerID(d.ObserverNameAnswerID);a=[];for(var h in c)for(var l in f)c[h].VoterID===f[l].VoterID&&e(a,c[h].VoterAnswerValue)&&a.push({Value:c[h].VoterAnswerValue,Name:f[l].VoterAnswerValue});h={DisplayOrder:-1,InputType:null,IsRequired:!0,Options:a,PlaceholderVariableName:"iaspireusername",RequestText:"Observer",SurveyID:b.SurveyID,SurveyVariableTypeID:"00000000-0000-0000-0000-000000000000",UpdateURL:null,UsePlaceholderAsUniqueVoteName:!1,ValueVariableName:"iaspireuserid"};
0<a.length&&b.FilterOptions.unshift(h);b.ReportDataIsLoading=!1}}function x(){function a(b,c){return c.filter(function(a){return a.QuestionID===b})}var c=[],f=[],e;for(e in b.ActiveSurvey.Questions){var h=a(b.ActiveSurvey.Questions[e].QuestionID,b.ActiveSurvey.Answers);0<h.length&&(c.push(b.ActiveSurvey.Questions[e]),c[c.length-1].Answers=h)}e=new RegExp(String.fromCharCode(160),"g");for(h=c.length-1;-1<h;h--){var g=c[h].QuestionText.replace(/(<[^>]*>)/g,"").replace(/((&lt;)(?:(?!&gt;).)*(&gt;))/g,
"").replace(/(\r\n?|\n)/g," ").replace(e,"").replace("&nbsp;","");c[h].CleanQuestionText=g||"";for(var l in c[h].Answers)g=(g=c[h].Answers[l].AnswerText.replace(/(<[^>]*>)/g,"").replace(/((&lt;)(?:(?!&gt;).)*(&gt;))/g,"").replace(/(\r\n?|\n)/g," ").replace(e,"").replace("&nbsp;",""))||"No Answer Text "+c[h].Answers[l].AnswerID,c[h].Answers[l].CleanAnswerText=g;var g=!1,q;for(q in c[h].Answers)!0===G(c[h].Answers[q].DefaultText,c[h].Answers[q].AnswerID)&&(g=!0);!0===g&&(f.push(c[h]),c.splice(h,1))}q=
[];l=[];for(var k in f)for(var r in f[k].Answers)e="",f[k].Answers[r].DefaultText&&""!==f[k].Answers[r].DefaultText&&(e=f[k].Answers[r].DefaultText.toLowerCase()),"##iaspireusername##"===e&&q.push({HeaderText:f[k].CleanQuestionText,DisplayOrder:0,AnswerID:f[k].Answers[r].AnswerID}),"##currentdatetime##"===e&&q.push({HeaderText:f[k].CleanQuestionText,DisplayOrder:1,AnswerID:f[k].Answers[r].AnswerID}),"##teachername##"===e&&q.push({HeaderText:f[k].CleanQuestionText,DisplayOrder:2,AnswerID:f[k].Answers[r].AnswerID}),
"##districtname##"===e&&q.push({HeaderText:f[k].CleanQuestionText,DisplayOrder:3,AnswerID:f[k].Answers[r].AnswerID}),"##schoolname##"===e&&q.push({HeaderText:f[k].CleanQuestionText,DisplayOrder:4,AnswerID:f[k].Answers[r].AnswerID}),"##gradename##"===e&&q.push({HeaderText:f[k].CleanQuestionText,DisplayOrder:5,AnswerID:f[k].Answers[r].AnswerID}),"##classname##"!==e&&"##subjectname##"!==e||q.push({HeaderText:f[k].CleanQuestionText,DisplayOrder:6,AnswerID:f[k].Answers[r].AnswerID});if(-1!==d.CurrentDateTimeAnswerID)for(k=
b.AllVotes.length-1;-1<k;k--){r=Object.keys(b.AllVotes[k]);for(var m in r)if(-1<r[m].indexOf("_"+d.CurrentDateTimeAnswerID)){r=moment(b.AllVotes[k][r[m]],"MM-DD-YYYY");r.isValid()||(r=moment(b.AllVotes[k].StartDate,"YYYY-MM-DDTHH:mm:ss"));r.isBetween(d.StartDate.subtract(1,"millisecond"),d.EndDate.add(1,"millisecond"))||(b.RemovedVotes.push(b.AllVotes[k]),b.AllVotes.splice(k,1));break}}if((m=F.ApplyFiltersToVotes(b.AllVotes,b.ActiveFilters))&&m.length&&0<m.length)for(d.SetFilteredVotesCount(m.length),
k=b.AllVotes.length-1;-1<k;k--){r=!1;for(var p in m)if(m[p]===b.AllVotes[k].VoterID){r=!0;break}!1===r&&b.AllVotes.splice(k,1)}else b.AllVotes=[];q.sort(w);f.sort(w);for(f=0;f<b.AllVotes.length;f++){p=[];for(m=0;m<q.length;m++){k=Object.keys(b.AllVotes[f]);for(var n in k)if(-1<k[n].indexOf("_"+q[m].AnswerID)){p.push(b.AllVotes[f][k[n]]);break}}l.push(p)}for(n=0;n<q.length;n++)b.HeaderDataTable.Headers.push(q[n].HeaderText);for(n=0;n<l.length;n++)b.HeaderDataTable.Rows.push(l[n]);c.sort(w);for(n=0;n<
c.length;n++)b.ReportingQuestions.push(c[n])}function w(a,b){return a.DisplayOrder-b.DisplayOrder}function G(a,b){if(a&&""!==a)switch(a.toLowerCase()){case "##districtid##":return d.SetDistrictIDAnswerID(b),!0;case "##schoolid##":return d.SetSchoolIDAnswerID(b),!0;case "##teacherid##":return d.SetTeacherIDAnswerID(b),!0;case "##gradeid##":return d.SetGradeIDAnswerID(b),!0;case "##classid##":case "##subjectid##":return d.SetSubjectIDAnswerID(b),!0;case "##currentdatetime##":return d.SetCurrentDateTimeAnswerID(b),
!0;case "##iaspireuserid##":return d.SetObserverIDAnswerID(b),!0;case "##iaspireusername##":return d.SetObserverNameAnswerID(b),!0;case "##currenttime##":case "##districtname##":case "##schoolname##":case "##teachername##":case "##gradename##":case "##classname##":case "##subjectname##":return!0}return!1}function H(a){var b=-1;"districtid"===a.ValueVariableName?b=d.DistrictIDAnswerID:"schoolid"===a.ValueVariableName?b=d.SchoolIDAnswerID:"teacherid"===a.ValueVariableName?b=d.TeacherIDAnswerID:"classid"===
a.ValueVariableName||"subjectid"===a.ValueVariableName?b=d.SubjectIDAnswerID:"gradeid"===a.ValueVariableName?b=d.GradeIDAnswerID:"iaspireuserid"===a.ValueVariableName&&(b=d.ObserverIDAnswerID);a=angular.copy(a);a.AnswerID=b;return a}var v=null,v=localStorage.getItem("ReportingSettings_DateRangeValue"),y=localStorage.getItem("ReportingSettings_DateRangeType");v&&y?(v=JSON.parse(v),v=moment().subtract(v,y).startOf("day")):v=moment().subtract(9,"week").hour(0).minute(0).second(0).millisecond(0);y=moment().endOf("day");
d.SetStartDate(v);d.SetEndDate(y);c.AppC.ShowHeader=!0;c.AppC.ShowFooter=!0;c.AppC.ActivePageName="Reports - Sample";var b=this;b.AreReportsReady=u.App.AreReportsReady;b.SurveyList=[];b.SurveyID=-1;b.momentFormat="YYYY-MM-DD";b.StartDateString=v.format(b.momentFormat);b.EndDateString=y.format(b.momentFormat);console.log(b.StartDateString);console.log(b.EndDateString);b.NeedNewDataObject={};b.NeedNewDataObject.NeedNewData=!1;b.GetNewData=function(){var a=!0,e;for(e in b.ActiveFilters)if(!b.ActiveFilters[e].FilterType||
!b.ActiveFilters[e].SelectedOption){a=!1;break}!0===a?setTimeout(function(){g.ClearCache();t.PrepForNewSurvey();b.ReportingQuestions=[];d.SetActiveSurvey(null);d.SetAllVotes([]);b.ReportDataIsLoading=!0;b.QuestionGroups=[];b.HeaderDataTable.Headers=[];b.HeaderDataTable.Rows=[];d.SetStartDate(moment(b.StartDateString,b.momentFormat));d.SetEndDate(moment(b.EndDateString,b.momentFormat));b.FilterOptions=angular.copy(d.OriginalFilters);b.AllVotes=angular.copy(d.OriginalVotes);b.ActiveSurvey=angular.copy(d.OriginalSurvey);
p(!0,!0,!0);b.NeedNewDataObject.NeedNewData=!1;c.$apply()},100):C.CreateInfoAlert("Alert","Please enter valid criteria for filtering")};b.AddFilter=function(a){b.ActiveFilters.push(H(a))};b.SurveysListIsLoading=!1;b.ReportDataIsLoading=!1;b.ActiveSurvey=null;b.FilterOptions=[];b.ActiveFilters=[];b.AllVotes=[];b.RemovedVotes=[];b.QuestionGroups=[];b.ReportingQuestions=[];b.HeaderDataTable={Headers:[],Rows:[]};b.RenderReport=function(){t.RenderReport()};var B=!1;!1===c.AppC.IsTrialVersion&&!0===b.AreReportsReady&&
(B=!0,b.SurveysListIsLoading=!0,c.AppC.ActivePageName="Reports",m());var E=e(function(){!1===B?!0===c.AppC.isUserAuthorized&&(B=!0,!1===c.AppC.IsTrialVersion&&!0===b.AreReportsReady&&(b.SurveysListIsLoading=!0,c.AppC.ActivePageName="Reports",m())):e.cancel(E)},500);c.$on("$destroy",function(){e.cancel(E)});c.$watch("repC.StartDateString",function(a,c){a&&a!==c&&(b.NeedNewDataObject.NeedNewData=!0)});c.$watch("repC.EndDateString",function(a,c){a&&a!==c&&(b.NeedNewDataObject.NeedNewData=!0)});c.$watchCollection("repC.ActiveFilters",
function(a,c){a&&a.length!==c.length&&(b.NeedNewDataObject.NeedNewData=!0)});c.$watch("repC.SurveyID",function(a,c){a&&a!==c&&-1!==a&&(!0===moment(b.StartDateString,b.momentFormat).isBefore(moment(b.EndDateString,b.momentFormat).endOf("day"))?(g.ClearCache(),b.NeedNewDataObject.NeedNewData=!1,b.ReportDataIsLoading=!0,b.ReportingQuestions=[],b.FilterOptions=[],b.ActiveFilters=[],b.AllVotes=[],b.RemovedVotes=[],b.QuestionGroups=[],b.HeaderDataTable.Headers=[],b.HeaderDataTable.Rows=[],d.SetActiveSurvey(null),
d.SetAllVotes([]),d.SetSurveyID(b.SurveyID),d.SetSurveyTitle(b.SurveyList.filter(function(a){return a.SurveyID===b.SurveyID?!0:!1})[0].Title),d.SetStartDate(moment(b.StartDateString,b.momentFormat)),d.SetEndDate(moment(b.EndDateString,b.momentFormat).endOf("day")),n(b.SurveyID,moment(b.StartDateString,b.momentFormat).format(),moment(b.EndDateString,b.momentFormat).endOf("day").format())):(C.CreateInfoAlert("Alert","Please enter a valid date range"),b.SurveyID=-1,d.SetSurveyID(-1),d.SetSurveyTitle("")))});
return b}])})();
