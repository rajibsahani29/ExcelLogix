(function(){angular.module("iAspireApp").directive("iframeOnload",function(){return{scope:{callBack:"&iframeOnload"},link:function(k,f,m){f.on("load",function(){return k.callBack()})}}}).controller("SurveyController",["DataService","$scope","SMAAlertFactory","$routeParams","ProjectConstants",function(k,f,m,r,h){function t(){k.getUpdatedSurveyVariables({UserID:f.AppC.ActiveUser.UserID||-1,SurveyID:b.SurveyID||-1,MerchantID:-1,SchoolID:-1,ClassID:-1,GradeID:-1,TeacherID:-1,StudentID:-1}).success(function(c,
a,d,g){if(c.length&&0<c.length){b.displayLoadingSpinner=!1;b.surveyHasPreSurveyQuestions=!0;for(var e in c)c[e].InputType?"datepicker"===c[e].InputType?c[e].SelectedOption=null:"time"===c[e].InputType?c[e].SelectedOption=new Date:"datetime-local"===c[e].InputType?(a=new Date,a.setSeconds(0,0),c[e].SelectedOption=a):c[e].SelectedOption=null:(c[e].SelectedOption=null,0===c[e].Options.length&&c[e].Options.push({Name:"No Data Available.",Value:-1}));b.preSurveySurveyQuestions=c}else u()}).error(function(b,
a,d,g){403===a&&m.CreateInfoAlert("Alert","You do not have access to this form.",function(){window.location.hash="#/selectForm"})})}function y(b,a){if(b&&a)for(var d in b)for(var g in a){if(d===g&&b[d]!==a[g])return!0}else return!0;return!1}function v(c){if(!0===b.isGettingNewData)w!=c&&setTimeout(function(){v(c);f.$apply()});else{w=c;for(var a=c.Options.length-1;-1<a;a--)c.Options[a].Value!==c.SelectedOption&&c.Options.splice(a,1);b.isGettingNewData=!0;var a={},d;for(d in b.preSurveySurveyQuestions)b.preSurveySurveyQuestions[d].SelectedOption&&
(a[b.preSurveySurveyQuestions[d].ValueVariableName.toUpperCase()]=b.preSurveySurveyQuestions[d].SelectedOption);d={UserID:a.USERID||f.AppC.ActiveUser.UserID||-1,SurveyID:a.SURVEYID||b.preSurveySurveyQuestions[0].SurveyID||-1,MerchantID:a.MERCHANTID||-1,SchoolID:a.SCHOOLID||-1,ClassID:a.CLASSID||a.SUBJECTID||-1,GradeID:a.GRADEID||-1,TeacherID:a.TEACHERID||-1,StudentID:a.STUDENTID||-1};y(x,d)?(x=d,console.table&&console.table([d]),k.getUpdatedSurveyVariables(d).success(function(a,c,d,f){for(var h in a)a[h].SelectedOption=
null;for(var l in b.preSurveySurveyQuestions)if(!b.preSurveySurveyQuestions[l].InputType||""===b.preSurveySurveyQuestions[l].InputType)for(var k in a)b.preSurveySurveyQuestions[l].ValueVariableName===a[k].ValueVariableName&&(b.preSurveySurveyQuestions[l].Options=[],b.preSurveySurveyQuestions[l].Options=a[k].Options,0===b.preSurveySurveyQuestions[l].Options.length&&b.preSurveySurveyQuestions[l].Options.push({Name:"No Data Available.",Value:-1}));b.isGettingNewData=!1}).error(function(a,c,d,f){b.isGettingNewData=
!1})):b.isGettingNewData=!1}}function u(){var c=!0,a;for(a in b.preSurveySurveyQuestions)if(!0===b.preSurveySurveyQuestions[a].IsRequired&&null===b.preSurveySurveyQuestions[a].SelectedOption){c=!1;break}if(!0===c){a=c="";for(var d in b.preSurveySurveyQuestions){a=b.preSurveySurveyQuestions[d];var g="",e=null,n=null,p=null,q=null;if(a.PlaceholderVariableName)if(p=a.PlaceholderVariableName,a.Options&&0<a.Options.length)for(e in e=void 0,a.Options){if(a.Options[e].Value===a.SelectedOption){q=encodeURIComponent(a.Options[e].Name);
break}}else throw Error("this should never happen.");"datetimepicker"===a.InputType&&(a.SelectedOption=(new Date(a.SelectedOption)).getTime());e=a.ValueVariableName;if(a.SelectedOption||!1===a.SelectedOption)n=encodeURIComponent(a.SelectedOption.toString());e&&n&&(g=g.concat("&"+e+"="+n));p&&q&&(g=g.concat("&"+p+"="+q));a=g&&""!==g?g:null;a&&""!==a&&(c=c.concat(a))}d=k.getAdminPanelSurveyURL(b.SurveyGuid,f.AppC.UserID,f.AppC.ActiveUser.SessionID);a=[];a.push(c);a.push("&"+h.QWRYSTR.CurrentDateTime+
"="+encodeURIComponent(h.QWRYSTRVal.CurrentDateTimeValue()));a.push("&"+h.QWRYSTR.CurrentTime+"="+encodeURIComponent(h.QWRYSTRVal.CurrentTimeValue()));f.AppC.ActiveUser.FirstName&&f.AppC.ActiveUser.LastName&&a.push("&"+h.QWRYSTR.iAspireUserName+"="+encodeURIComponent(f.AppC.ActiveUser.FirstName+" "+f.AppC.ActiveUser.LastName));d+=a.join("");document.getElementById("surveyIFrame").setAttribute("src",d)}else m.CreateInfoAlert("Alert","You have required questions that\nhave not been answered")}f.AppC.ShowHeader=
!0;f.AppC.ShowFooter=!0;f.AppC.ActivePageName="Form";var b=this;b.AnimationClass="pageTransitionAnimation";b.SurveyID=r.SurveyID;b.SurveyGuid=r.SurveyGuid;b.isSurveyLoaded=!1;b.surveyHasPreSurveyQuestions=!1;b.displayLoadingSpinner=null;b.preSurveySurveyQuestions=[];b.getUpdatedSurveyData=v;b.resetPreSurveySurveyQuestionAnswers=function(){b.preSurveySurveyQuestions=[];t()};b.isGettingNewData=!1;b.iframeLoadedCallback=function(){function c(){"function"==typeof d&&d();setTimeout(function(){if(a){var b=
$(window).height()-50-40+"px";481<=window.innerWidth&&761>window.innerWidth?b=$(window).height()-55-45+"px":761<=window.innerWidth&&(b=$(window).height()-60-50+"px");a.style.minHeight=b;a.style.border="0";a.style.width="100%";a.style.display="block";a.style.position="relative";setTimeout(function(){-1<a.src.indexOf("ViewVote.aspx")?a.style.height=$(a).contents().find("#Panel").height()+"px":-1<a.src.indexOf("iAspireSurveyMobile.aspx")&&(a.style.height=$(a).contents().find("body").height()+"px")},
1)}},1)}b.displayLoadingSpinner=!1;var a=document.getElementById("surveyIFrame");if(""!==a.getAttribute("src")){b.isSurveyLoaded=!0;b.surveyHasPreSurveyQuestions=!1;var d=window.onresize;window.onresize=c;setTimeout(function(){c()},1);window.onhashchange=function(){window.onresize=null;window.onresize=d};f.$apply()}};t();window.document.getElementsByTagName("iframe")[0].addEventListener(h.Events.SurveyComplete,function(b){setTimeout(function(){window.location.hash="#selectForm"},3E3)});b.getSurvey=
u;b.backToSelectionPage=function(b){function a(a){!0===a&&(window.location.hash="#/selectForm")}b=document.getElementById("surveyIFrame");b.getAttribute("src")&&""!==b.getAttribute("src")?-1<b.getAttribute("src").indexOf("iAspireSurveyMobile.aspx")&&m.CreateConfirmAlert("\nAre you sure you wish to\nexit without saving or submitting?",null,null,null,a):window.location.hash="#/selectForm"};b.toSettingsPage=function(b){function a(a){!0===a&&(window.location.hash="#/settings")}b=document.getElementById("surveyIFrame");
b.getAttribute("src")&&""!==b.getAttribute("src")?-1<b.getAttribute("src").indexOf("iAspireSurveyMobile.aspx")&&m.CreateConfirmAlert("\nAre you sure you wish to\nexit without saving or submitting?",null,null,null,a):window.location.hash="#/selectForm"};setTimeout(function(){!1!==b.displayLoadingSpinner&&(b.displayLoadingSpinner=!0);f.$apply()},h.Integers.LoadDelayTime);var w=null,x=null;return b}])})();
